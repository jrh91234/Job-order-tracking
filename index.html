<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Order Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts (Prompt for Thai) -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Fuse.js for Fuzzy Search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        html { scroll-behavior: smooth; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Screen Animation */
        .fade-out {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-20 min-h-screen">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-4 transition-all duration-500">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center border border-slate-700">
            <div class="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="lock" class="w-8 h-8 text-slate-800"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-1">เข้าสู่ระบบ</h2>
            <p class="text-slate-500 text-sm mb-6">กรุณากรอกรหัสผ่านเพื่อเข้าถึงข้อมูล</p>
            
            <form onsubmit="handleLogin(event)">
                <input type="tel" id="pin-input" 
                    class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-center text-2xl font-bold tracking-widest text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4"
                    placeholder="• • • •" maxlength="4" autocomplete="off">
                
                <button type="submit" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-slate-200">
                    ยืนยัน
                </button>
            </form>
            <p id="login-error" class="text-red-500 text-xs mt-3 hidden flex items-center justify-center gap-1">
                <i data-lucide="alert-circle" class="w-3 h-3"></i> รหัสผ่านไม่ถูกต้อง
            </p>
           
        </div>
    </div>

    <!-- Header -->
    <header id="main-header" class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-30">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                Job Monitor
            </h1>
            <div class="flex items-center gap-2">
                <span id="last-updated" class="text-xs bg-indigo-500 px-2 py-1 rounded-full text-indigo-100 hidden">
                    Updated: -
                </span>
                <button id="settings-btn" onclick="toggleSettings()" class="p-1.5 bg-indigo-500 rounded-lg hover:bg-indigo-400 transition-colors">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="relative">
            <input
                type="text"
                id="searchInput"
                placeholder="ค้นหา Job, Model หรือ วันที่..."
                class="w-full pl-10 pr-4 py-3 rounded-xl text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-300 shadow-sm placeholder-slate-400"
            />
            <i data-lucide="search" class="absolute left-3 top-3.5 text-slate-400 w-5 h-5"></i>
        </div>
    </header>

    <!-- Demo Mode Warning -->
    <div id="demo-banner" class="hidden bg-yellow-50 border-b border-yellow-200 px-4 py-2 flex items-center justify-between sticky top-[130px] z-20">
        <div class="flex items-center gap-2 text-xs text-yellow-800">
            <i data-lucide="info" class="w-4 h-4"></i>
            <span>กำลังแสดงข้อมูลตัวอย่าง</span>
        </div>
        <button onclick="toggleSettings()" class="text-xs font-bold text-indigo-600 underline">
            เชื่อมต่อ Google Sheet
        </button>
    </div>

    <!-- Stats Summary Cards -->
    <div id="stats-container" class="grid grid-cols-3 gap-3 p-4 sticky top-[130px] z-10 bg-slate-50/95 backdrop-blur-sm border-b border-slate-200 shadow-sm transition-all duration-300">
        <!-- Card: All -->
        <div onclick="setFilter('all')" id="filter-all"
             class="p-3 rounded-xl shadow-sm text-center border-2 cursor-pointer transition-all bg-white border-indigo-500 transform active:scale-95">
            <div class="text-slate-500 text-xs mb-1">ทั้งหมด</div>
            <div class="text-xl font-bold text-slate-800" id="stat-total">0</div>
        </div>
        
        <!-- Card: Incomplete (Pending) -->
        <div onclick="setFilter('incomplete')" id="filter-incomplete"
             class="p-3 rounded-xl shadow-sm text-center border-2 cursor-pointer transition-all bg-white border-transparent transform active:scale-95 relative overflow-hidden group">
            <div class="absolute inset-0 bg-orange-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <div class="relative z-10">
                <div class="text-orange-600 text-xs mb-1 font-bold flex items-center justify-center gap-1">
                    ค้างอยู่ <i data-lucide="chevron-right" class="w-3 h-3"></i>
                </div>
                <div class="text-xl font-bold text-orange-700" id="stat-pending">0</div>
                <div class="text-[10px] text-orange-400 mt-1">แตะเพื่อดู</div>
            </div>
        </div>

        <!-- Card: Complete -->
        <div onclick="setFilter('complete')" id="filter-complete"
             class="p-3 rounded-xl shadow-sm text-center border-2 cursor-pointer transition-all bg-white border-transparent transform active:scale-95">
            <div class="text-green-600 text-xs mb-1">เสร็จแล้ว</div>
            <div class="text-xl font-bold text-green-700" id="stat-completed">0</div>
        </div>
    </div>

    <!-- Date Range Filter (Hidden by default) -->
    <div id="date-filter-panel" class="hidden px-4 mt-2 mb-2 transition-all duration-300">
        <div class="bg-white p-3 rounded-xl border border-indigo-100 shadow-sm">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold text-slate-500 flex items-center gap-1">
                    <i data-lucide="calendar" class="w-3 h-3"></i> กรองช่วงวันที่
                </span>
                <button onclick="clearDateFilter()" class="text-[10px] text-indigo-600 underline">ล้างวันที่</button>
            </div>
            <div class="flex gap-2 items-center">
                <div class="flex-1">
                    <input type="date" id="start-date" onchange="renderList()" class="w-full text-xs p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-slate-600">
                </div>
                <span class="text-slate-300">-</span>
                <div class="flex-1">
                    <input type="date" id="end-date" onchange="renderList()" class="w-full text-xs p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-slate-600">
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="px-4 mt-2">
        <div class="flex items-center justify-between text-sm text-slate-500 px-1 mb-3">
            <span id="list-count">รายการ (0)</span>
            <div class="flex items-center gap-2">
                <div id="loading-indicator" class="hidden"><div class="loader"></div></div>
                
                <!-- Clear Filter Button -->
                <button id="clear-filter-btn" onclick="clearAllFilters()" class="hidden flex items-center gap-1 text-indigo-600 font-medium bg-indigo-50 px-2 py-1 rounded-lg text-xs">
                    แสดงทั้งหมด <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                </button>

                <!-- Date Filter Toggle Button -->
                <button id="date-filter-btn" onclick="toggleDateFilter()" class="flex items-center justify-center w-8 h-8 text-slate-400 hover:text-indigo-600 bg-white border border-slate-200 rounded-lg transition-colors shadow-sm">
                    <i data-lucide="calendar-range" class="w-4 h-4"></i>
                </button>

                <!-- Sort Button -->
                <button id="sort-btn" onclick="toggleSort()" class="flex items-center gap-1 text-slate-400 hover:text-indigo-600 bg-white border border-slate-200 px-2 py-1.5 rounded-lg text-xs transition-colors shadow-sm">
                    <span id="sort-label">ปกติ</span>
                    <i data-lucide="arrow-up-down" class="w-3.5 h-3.5"></i>
                </button>

                <!-- Refresh Button -->
                <button onclick="reloadData()" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-slate-100 rounded-lg transition-colors">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <div id="job-list" class="space-y-3 pb-6">
            <!-- Jobs injected here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12 text-slate-400">
            <i data-lucide="search" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
            <p>ไม่พบข้อมูลที่ค้นหา</p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">ตั้งค่า</h3>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Section 1: Connection -->
                <div>
                    <h4 class="text-sm font-semibold text-slate-800 mb-2 flex items-center gap-2">
                        <i data-lucide="link" class="w-4 h-4"></i> การเชื่อมต่อ
                    </h4>
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <label class="block text-xs font-medium text-slate-500 mb-1">ลิงก์ CSV (Google Sheet)</label>
                        <input type="text" id="sheet-url-input" 
                            class="w-full p-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm mb-2"
                            placeholder="https://docs.google.com/.../pub?output=csv">
                        <div class="flex gap-2">
                            <button onclick="saveSettings()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">
                                บันทึก
                            </button>
                            <button onclick="useDemoData()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100">
                                ใช้ Demo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Security -->
                <div>
                    <h4 class="text-sm font-semibold text-slate-800 mb-2 flex items-center gap-2">
                        <i data-lucide="lock" class="w-4 h-4"></i> ความปลอดภัย
                    </h4>
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">เปลี่ยนรหัสผ่าน (PIN)</label>
                            <div class="flex gap-2">
                                <input type="tel" id="new-pin-input" 
                                    class="w-full p-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
                                    placeholder="ใส่รหัสใหม่ 4 หลัก" maxlength="4">
                                <button onclick="changePin()" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm hover:bg-slate-900">
                                    เปลี่ยน
                                </button>
                            </div>
                        </div>
                        <hr class="border-slate-200">
                        <button onclick="handleLogout()" class="w-full text-red-600 border border-red-200 bg-red-50 py-2 rounded-lg text-sm font-medium hover:bg-red-100 flex items-center justify-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i> ออกจากระบบ
                        </button>
                    </div>
                </div>

                <div class="text-center text-xs text-slate-400 pt-2">
                    Job Order Tracker v1.8 (Date Range Filter)
                </div>
            </div>
        </div>
    </div>

    <!-- Scroll to Top -->
    <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"
        class="fixed bottom-6 right-6 bg-indigo-600 text-white p-3 rounded-full shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-colors z-30 active:scale-90 transform">
        <i data-lucide="arrow-up" class="w-6 h-6"></i>
    </button>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const FIXED_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRlXWxz5TKmlYhh7oxo3Fz2KgWK36xlJD8k9NTNK6XUFs5c1RRnYIkAYizQUzJHJofOGFAQaVvy47gT/pub?gid=1416776201&single=true&output=csv"; 
        
        const DEFAULT_PIN = "1111";

        // ==========================================
        // MOCK DATA
        // ==========================================
        const MOCK_DATA = [
            { id: 1, date: '16/9/2025', jobNo: 'TH-SCDD2025090244', model: 'S9HCL14', plan: 600, actual: 600, progress: 100, status: 'complete', finishDate: '2025/09/19' },
            { id: 2, date: '17/9/2025', jobNo: 'TH-SCDD2025090255', model: 'Q03-100EZ42G/SN', plan: 480, actual: 480, progress: 100, status: 'complete', finishDate: '2025/09/18' },
            { id: 3, date: '18/9/2025', jobNo: 'TH-SCDD2025090266', model: 'MX9E2215F', plan: 149, actual: 149, progress: 100, status: 'complete', finishDate: '2025/09/19' },
            { id: 4, date: '30/9/2025', jobNo: 'TH-SCDD2025090426', model: 'MX9E2315S', plan: 27, actual: 10, progress: 37, status: 'incomplete', finishDate: '-' },
        ];

        // ==========================================
        // SYSTEM LOGIC
        // ==========================================

        let rawData = [];
        let fuse;
        let currentFilter = 'all';
        let currentSort = 'default';
        let searchTerm = '';
        let sheetUrl = FIXED_SHEET_URL || localStorage.getItem('job_tracker_sheet_url') || '';
        let isDemoMode = false;

        const els = {
            mainHeader: document.getElementById('main-header'),
            statsContainer: document.getElementById('stats-container'),
            loginOverlay: document.getElementById('login-overlay'),
            pinInput: document.getElementById('pin-input'),
            loginError: document.getElementById('login-error'),
            newPinInput: document.getElementById('new-pin-input'),
            jobList: document.getElementById('job-list'),
            searchInput: document.getElementById('searchInput'),
            statTotal: document.getElementById('stat-total'),
            statPending: document.getElementById('stat-pending'),
            statCompleted: document.getElementById('stat-completed'),
            listCount: document.getElementById('list-count'),
            emptyState: document.getElementById('empty-state'),
            demoBanner: document.getElementById('demo-banner'),
            clearFilterBtn: document.getElementById('clear-filter-btn'),
            settingsModal: document.getElementById('settings-modal'),
            sheetUrlInput: document.getElementById('sheet-url-input'),
            loadingIndicator: document.getElementById('loading-indicator'),
            lastUpdated: document.getElementById('last-updated'),
            sortBtn: document.getElementById('sort-btn'),
            sortLabel: document.getElementById('sort-label'),
            dateFilterBtn: document.getElementById('date-filter-btn'),
            dateFilterPanel: document.getElementById('date-filter-panel'),
            startDate: document.getElementById('start-date'),
            endDate: document.getElementById('end-date')
        };

        function init() {
            lucide.createIcons();
            checkAuth();
            
            els.searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                renderList();
            });
        }

        // --- Auth System ---
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('job_tracker_auth');
            if (isLoggedIn === 'true') {
                els.loginOverlay.style.display = 'none';
                startApp();
            } else {
                setTimeout(() => els.pinInput.focus(), 500);
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const inputPin = els.pinInput.value;
            const savedPin = localStorage.getItem('job_tracker_pin') || DEFAULT_PIN;

            if (inputPin === savedPin) {
                localStorage.setItem('job_tracker_auth', 'true');
                els.loginOverlay.classList.add('fade-out');
                setTimeout(() => {
                    els.loginOverlay.style.display = 'none';
                    startApp();
                }, 500);
            } else {
                els.loginError.classList.remove('hidden');
                els.pinInput.value = '';
                els.pinInput.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => els.pinInput.classList.remove('ring-2', 'ring-red-500'), 1000);
            }
        }

        function handleLogout() {
            if(confirm('ต้องการออกจากระบบใช่หรือไม่?')) {
                localStorage.removeItem('job_tracker_auth');
                location.reload();
            }
        }

        function changePin() {
            const newPin = els.newPinInput.value;
            if (newPin.length !== 4 || isNaN(newPin)) {
                alert('กรุณากรอกรหัสผ่านใหม่เป็นตัวเลข 4 หลัก');
                return;
            }
            localStorage.setItem('job_tracker_pin', newPin);
            els.newPinInput.value = '';
            alert('เปลี่ยนรหัสผ่านเรียบร้อยแล้ว');
        }

        // --- Main App Logic ---
        function startApp() {
            if (sheetUrl) {
                els.sheetUrlInput.value = sheetUrl;
                fetchData();
            } else {
                loadMockData();
            }
        }

        function reloadData() {
            if(isDemoMode && !sheetUrl) {
                toggleSettings();
            } else {
                fetchData();
            }
        }

        // --- Date Filter Logic ---
        function toggleDateFilter() {
            els.dateFilterPanel.classList.toggle('hidden');
            if (!els.dateFilterPanel.classList.contains('hidden')) {
                els.dateFilterBtn.classList.add('bg-indigo-50', 'text-indigo-600', 'border-indigo-200');
            } else {
                els.dateFilterBtn.classList.remove('bg-indigo-50', 'text-indigo-600', 'border-indigo-200');
            }
        }

        function clearDateFilter() {
            els.startDate.value = '';
            els.endDate.value = '';
            renderList();
        }

        function clearAllFilters() {
            setFilter('all');
            clearDateFilter();
            // Optional: reset sort
            // currentSort = 'default';
            // updateSortUI();
        }

        // --- Sorting Logic ---
        function toggleSort() {
            if (currentSort === 'default') {
                currentSort = 'newest';
            } else if (currentSort === 'newest') {
                currentSort = 'oldest';
            } else {
                currentSort = 'default';
            }
            updateSortUI();
            renderList();
        }

        function updateSortUI() {
            let iconName = 'arrow-up-down';
            let labelText = 'ปกติ';
            let btnClass = "flex items-center gap-1 bg-white border border-slate-200 px-2 py-1.5 rounded-lg text-xs transition-colors shadow-sm text-slate-400 hover:text-indigo-600";

            if (currentSort === 'newest') {
                iconName = 'arrow-down';
                labelText = 'ใหม่-เก่า';
                btnClass = "flex items-center gap-1 bg-indigo-50 border border-indigo-200 px-2 py-1.5 rounded-lg text-xs transition-colors shadow-sm text-indigo-700 font-medium";
            } else if (currentSort === 'oldest') {
                iconName = 'arrow-up';
                labelText = 'เก่า-ใหม่';
                btnClass = "flex items-center gap-1 bg-indigo-50 border border-indigo-200 px-2 py-1.5 rounded-lg text-xs transition-colors shadow-sm text-indigo-700 font-medium";
            }

            els.sortLabel.textContent = labelText;
            els.sortBtn.className = btnClass;

            const oldIcon = els.sortBtn.querySelector('svg') || els.sortBtn.querySelector('i');
            if (oldIcon) oldIcon.remove();

            const newIcon = document.createElement('i');
            newIcon.setAttribute('data-lucide', iconName);
            newIcon.setAttribute('class', 'w-3.5 h-3.5');
            els.sortBtn.appendChild(newIcon);

            lucide.createIcons();
        }

        function parseDate(dateStr) {
            if (!dateStr || dateStr === '-') return new Date(0); 
            const parts = dateStr.split('/');
            if (parts.length !== 3) return new Date(0);
            return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }

        function initFuse(data) {
            const options = {
                keys: ['jobNo', 'model', 'date'],
                threshold: 0.3,
                ignoreLocation: true,
                minMatchCharLength: 2
            };
            fuse = new Fuse(data, options);
        }

        function loadMockData() {
            isDemoMode = true;
            rawData = MOCK_DATA;
            initFuse(rawData);
            
            els.demoBanner.classList.remove('hidden');
            els.statsContainer.style.top = '170px'; 
            
            renderStats();
            renderList();
            
            const now = new Date();
            els.lastUpdated.textContent = `Demo Mode`;
            els.lastUpdated.classList.remove('hidden');
            els.lastUpdated.classList.remove('bg-indigo-500', 'text-indigo-100');
            els.lastUpdated.classList.add('bg-yellow-200', 'text-yellow-800');
        }

        function fetchData() {
            if (!sheetUrl) return loadMockData();

            els.loadingIndicator.classList.remove('hidden');

            Papa.parse(sheetUrl, {
                download: true,
                header: true, 
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                    els.loadingIndicator.classList.add('hidden');
                    
                    isDemoMode = false;
                    els.demoBanner.classList.add('hidden');
                    els.statsContainer.style.top = '130px'; 

                    const now = new Date();
                    els.lastUpdated.textContent = `Updated: ${now.toLocaleDateString('th-TH')} ${now.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}`;
                    els.lastUpdated.classList.remove('hidden');
                    els.lastUpdated.classList.add('bg-indigo-500', 'text-indigo-100');
                    els.lastUpdated.classList.remove('bg-yellow-200', 'text-yellow-800');
                },
                error: function(err) {
                    console.error("Error fetching CSV:", err);
                    alert("ไม่สามารถดึงข้อมูลได้ ระบบจะแสดงข้อมูลตัวอย่างแทน");
                    els.loadingIndicator.classList.add('hidden');
                    loadMockData();
                }
            });
        }

        function processData(data) {
            if (data.length === 0) return;

            const keys = Object.keys(data[0]);
            
            const findKey = (keywords) => keys.find(k => 
                keywords.some(kw => k.toLowerCase().trim() === kw.toLowerCase().trim() || k.toLowerCase().includes(kw.toLowerCase()))
            );

            let jobKey = keys.find(k => k.includes('Job order No.')); 
            if (!jobKey) jobKey = findKey(['Job order', 'Job No']);

            let modelKey = keys.find(k => k.trim() === 'Order model');
            if (!modelKey) modelKey = findKey(['Model', 'Order']);

            let planKey = keys.find(k => k.includes('Plan จำนวน'));
            if (!planKey) planKey = findKey(['Plan']);

            let actualKey = keys.find(k => k.trim() === 'Actual');
            if (!actualKey) actualKey = keys.find(k => k.toLowerCase().includes('actual') && !k.toLowerCase().includes('date'));

            let progressKey = keys.find(k => k.includes('# Progress %'));
            if (!progressKey) progressKey = findKey(['Progress', '%']);

            let dateKey = keys.find(k => k.includes('Date') || k.includes('วันที่'));

            let finishKey = keys.find(k => k.toLowerCase().includes('actual complete date'));

            console.log("Mapped Keys:", {jobKey, modelKey, planKey, actualKey, progressKey, dateKey, finishKey});

            rawData = data
                .filter(row => row[jobKey] && row[modelKey]) 
                .map((row, index) => {
                    const plan = parseInt(row[planKey]?.replace(/,/g, '') || 0);
                    const actual = parseInt(row[actualKey]?.replace(/,/g, '') || 0);
                    const progressRaw = row[progressKey]?.replace(/%/g, '') || '0';
                    const progress = parseFloat(progressRaw);
                    const isComplete = progress === 100;
                    
                    return {
                        id: index,
                        date: row[dateKey] || '-',
                        jobNo: row[jobKey] || '-',
                        model: row[modelKey] || '-',
                        plan: plan,
                        actual: actual,
                        progress: progress,
                        status: isComplete ? 'complete' : 'incomplete',
                        finishDate: row[finishKey] || '-'
                    };
                });

            initFuse(rawData);
            renderStats();
            renderList();
        }

        function toggleSettings() {
            els.settingsModal.classList.toggle('hidden');
        }

        function useDemoData() {
             localStorage.removeItem('job_tracker_sheet_url');
             sheetUrl = '';
             els.sheetUrlInput.value = '';
             toggleSettings();
             loadMockData();
        }

        function saveSettings() {
            const url = els.sheetUrlInput.value.trim();
            if (!url) return alert('กรุณาใส่ลิงก์');
            
            localStorage.setItem('job_tracker_sheet_url', url);
            sheetUrl = url;
            toggleSettings();
            fetchData();
        }

        function setFilter(type) {
            currentFilter = type;
            updateFilterUI(type);
            renderList();
        }

        function updateFilterUI(type) {
            ['all', 'incomplete', 'complete'].forEach(f => {
                const el = document.getElementById(`filter-${f}`);
                el.className = `p-3 rounded-xl shadow-sm text-center border-2 cursor-pointer transition-all transform active:scale-95 bg-white border-transparent relative overflow-hidden group`;
            });

            const activeEl = document.getElementById(`filter-${type}`);
            if (type === 'all') activeEl.classList.add('border-indigo-500');
            if (type === 'incomplete') activeEl.classList.add('bg-orange-50', 'border-orange-500');
            if (type === 'complete') activeEl.classList.add('bg-green-50', 'border-green-500');

            if (type !== 'all') {
                els.clearFilterBtn.classList.remove('hidden');
                els.clearFilterBtn.innerHTML = `แสดงทั้งหมด <i data-lucide="rotate-ccw" class="w-3 h-3"></i>`;
            } else {
                els.clearFilterBtn.classList.add('hidden');
            }
        }

        function renderStats() {
            const total = rawData.length;
            const completed = rawData.filter(i => i.progress === 100).length;
            const pending = total - completed;

            els.statTotal.textContent = total;
            els.statPending.textContent = pending;
            els.statCompleted.textContent = completed;
        }

        function renderList() {
            let searchResults = rawData;
            
            // 1. Fuzzy Search
            if (searchTerm.trim() !== '') {
                const results = fuse.search(searchTerm);
                searchResults = results.map(result => result.item);
            }

            let filteredData = [...searchResults];
            
            // 2. Status Filter
            filteredData = filteredData.filter(item => {
                const matchesFilter = 
                    currentFilter === 'all' ? true :
                    currentFilter === 'complete' ? item.progress === 100 :
                    item.progress < 100;

                return matchesFilter;
            });

            // 3. Date Range Filter
            const startDateVal = els.startDate.value;
            const endDateVal = els.endDate.value;
            
            if (startDateVal || endDateVal) {
                const start = startDateVal ? new Date(startDateVal) : new Date('1900-01-01');
                const end = endDateVal ? new Date(endDateVal) : new Date('2100-01-01');
                // Reset hours for comparison
                start.setHours(0,0,0,0);
                end.setHours(23,59,59,999);

                filteredData = filteredData.filter(item => {
                    const itemDate = parseDate(item.date);
                    // Invalid/No date items will be excluded if filter is active
                    if (itemDate.getTime() === new Date(0).getTime()) return false; 
                    return itemDate >= start && itemDate <= end;
                });
            }

            // 4. Sort
            if (currentSort !== 'default') {
                filteredData.sort((a, b) => {
                    const dateA = parseDate(a.date);
                    const dateB = parseDate(b.date);
                    
                    if (currentSort === 'newest') {
                        return dateB - dateA;
                    } else {
                        return dateA - dateB;
                    }
                });
            }

            els.listCount.textContent = `รายการ (${filteredData.length})`;

            // Show clear button logic update for date range
            if (startDateVal || endDateVal || currentFilter !== 'all') {
                 els.clearFilterBtn.classList.remove('hidden');
            } else {
                 els.clearFilterBtn.classList.add('hidden');
            }

            if (filteredData.length === 0 && rawData.length > 0) {
                els.jobList.innerHTML = '';
                els.emptyState.classList.remove('hidden');
            } else {
                els.emptyState.classList.add('hidden');
                els.jobList.innerHTML = filteredData.map(item => createJobCard(item)).join('');
                lucide.createIcons();
            }
        }

        function createJobCard(data) {
            const isComplete = data.progress === 100;
            const statusBorder = isComplete ? 'border-green-500' : 'border-orange-400';
            const progressBarColor = isComplete ? 'bg-green-500' : 'bg-orange-400';
            const statusTextClass = isComplete ? 'text-green-600' : 'text-orange-600';
            
            const diff = data.actual - data.plan;
            const diffClass = diff > 0 ? 'text-red-500' : 'text-slate-400';

            const icon = isComplete 
                ? `<i data-lucide="check-circle" class="text-green-500 w-6 h-6 flex-shrink-0"></i>` 
                : `<i data-lucide="clock" class="text-orange-400 w-6 h-6 flex-shrink-0"></i>`;

            const footerText = isComplete
                ? `<span class="text-green-600 flex items-center justify-end gap-1">เสร็จสิ้นเมื่อ: ${data.finishDate}</span>`
                : `<span class="text-orange-500 flex items-center justify-end gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> สถานะ: ยังไม่สมบูรณ์</span>`;

            return `
                <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 relative overflow-hidden ${statusBorder}">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs text-slate-400 font-mono block mb-1">${data.date}</span>
                            <h3 class="text-base font-bold text-slate-800 break-all">${data.jobNo}</h3>
                        </div>
                        ${icon}
                    </div>

                    <div class="mb-4">
                        <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-medium">
                            Model: ${data.model}
                        </span>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between text-xs mb-1.5">
                            <span class="text-slate-500">ความคืบหน้า</span>
                            <span class="font-bold ${statusTextClass}">${data.progress}%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full progress-bar ${progressBarColor}" style="width: ${data.progress}%"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-sm bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <div class="flex flex-col">
                            <span class="text-xs text-slate-400">แผน (Plan)</span>
                            <span class="font-semibold text-slate-700">${data.plan.toLocaleString()}</span>
                        </div>
                        <div class="flex flex-col border-l border-slate-200 pl-3">
                            <span class="text-xs text-slate-400">ทำได้จริง (Actual)</span>
                            <span class="font-bold ${data.actual < data.plan ? 'text-orange-600' : 'text-green-600'}">
                                ${data.actual.toLocaleString()}
                            </span>
                        </div>
                        <div class="col-span-2 border-t border-slate-200 mt-1 pt-2 flex justify-between items-center">
                            <span class="text-xs text-slate-400">คงเหลือ (Diff)</span>
                            <span class="font-mono font-medium ${diffClass}">
                                ${(data.actual - data.plan).toLocaleString()}
                            </span>
                        </div>
                    </div>

                    <div class="mt-3 text-xs text-right">
                        ${footerText}
                    </div>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>
